const courseContent = [
    {
        moduleName: "Vocabulary",
        moduleId: "vocabularyModule",
        subModules: [
            {
                subModuleName: "Introduction to Universum Vocabulary",
                subModuleId: "Vocabulary_1",
                lessons: [
                    { title: "Lesson 1: Common Phrases", pageUrl: "../knowledge/vocabulary/level1/lesson-1.html" },
                    { title: "Lesson 2: Numbers and Counting", pageUrl: "../knowledge/vocabulary/level1/lesson-2.html" },
                    { title: "Lesson 3: Colors and Shapes", pageUrl: "../knowledge/vocabulary/level1/lesson-3.html" },
                    { title: "Lesson 4: Time and Days", pageUrl: "../knowledge/vocabulary/level1/lesson-4.html" }
                ]
            },
            {
                subModuleName: "Everyday Vocabulary",
                subModuleId: "Vocabulary_2",
                lessons: [
                    { title: "Lesson 1: Family and People", pageUrl: "../knowledge/vocabulary/level2/lesson-1.html" },
                    { title: "Lesson 2: Food and Drink", pageUrl: "../knowledge/vocabulary/level2/lesson-2.html" },
                    { title: "Lesson 3: Clothing and Body", pageUrl: "../knowledge/vocabulary/level2/lesson-3.html" },
                    { title: "Lesson 4: Home and Daily Routines", pageUrl: "../knowledge/vocabulary/level2/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Describing the World",
                subModuleId: "Vocabulary_3",
                lessons: [
                    { title: "Lesson 1: Nature and Weather", pageUrl: "../knowledge/vocabulary/level3/lesson-1.html" },
                    { title: "Lesson 2: City and Transportation", pageUrl: "../knowledge/vocabulary/level3/lesson-2.html" },
                    { title: "Lesson 3: Shopping and Money", pageUrl: "../knowledge/vocabulary/level3/lesson-3.html" },
                    { title: "Lesson 4: Health and Emergency", pageUrl: "../knowledge/vocabulary/level3/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Expressing Ideas and Feelings",
                subModuleId: "Vocabulary_4",
                lessons: [
                    { title: "Lesson 1: Emotions and Opinions", pageUrl: "../knowledge/vocabulary/level4/lesson-1.html" },
                    { title: "Lesson 2: Hobbies and Leisure", pageUrl: "../knowledge/vocabulary/level4/lesson-2.html" },
                    { title: "Lesson 3: Education and Work", pageUrl: "../knowledge/vocabulary/level4/lesson-3.html" },
                    { title: "Lesson 4: Travel and Culture", pageUrl: "../knowledge/vocabulary/level4/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Advanced Communication",
                subModuleId: "Vocabulary_5",
                lessons: [
                    { title: "Lesson 1: Complex Descriptions", pageUrl: "../knowledge/vocabulary/level5/lesson-1.html" },
                    { title: "Lesson 2: Abstract Concepts", pageUrl: "../knowledge/vocabulary/level5/lesson-2.html" },
                    { title: "Lesson 3: Formal and Informal Language", pageUrl: "../knowledge/vocabulary/level5/lesson-3.html" },
                    { title: "Lesson 4: Compound Word Construction", pageUrl: "../knowledge/vocabulary/level5/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Specialized Vocabulary",
                subModuleId: "Vocabulary_6",
                lessons: [
                    { title: "Lesson 1: Science and Technology", pageUrl: "../knowledge/vocabulary/level6/lesson-1.html" },
                    { title: "Lesson 2: Arts and Literature", pageUrl: "../knowledge/vocabulary/level6/lesson-2.html" },
                    { title: "Lesson 3: Business and Economy", pageUrl: "../knowledge/vocabulary/level6/lesson-3.html" },
                    { title: "Lesson 4: Politics and Society", pageUrl: "../knowledge/vocabulary/level6/lesson-4.html" }
                    // Add more lessons
                ]
            }
        ]
    },
    {
        moduleName: "Grammar",
        moduleId: "grammarModule",
        subModules: [
            {
                subModuleName: "Basics of Universum Grammar",
                subModuleId: "Grammar_1",
                lessons: [
                    { title: "Lesson 1: Sentence Structure", pageUrl: "../knowledge/grammar/level1/lesson-1.html" },
                    { title: "Lesson 2: Pronouns and Simple Verbs", pageUrl: "../knowledge/grammar/level1/lesson-2.html" },
                    { title: "Lesson 3: Present, Past, and Future Tenses", pageUrl: "../knowledge/grammar/level1/lesson-3.html" },
                    { title: "Lesson 4: Yes/No Questions and Answers", pageUrl: "../knowledge/grammar/level1/lesson-4.html" }
                ]
            },
            {
                subModuleName: "Building Complexity",
                subModuleId: "Grammar_2",
                lessons: [
                    { title: "Lesson 1: Negation", pageUrl: "../knowledge/grammar/level2/lesson-1.html" },
                    { title: "Lesson 2: Plurals and Quantity", pageUrl: "../knowledge/grammar/level2/lesson-2.html" },
                    { title: "Lesson 3: Descriptive Language", pageUrl: "../knowledge/grammar/level2/lesson-3.html" },
                    { title: "Lesson 4: Prepositions and Directions", pageUrl: "../knowledge/grammar/level2/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Expanding Expressions",
                subModuleId: "Grammar_3",
                lessons: [
                    { title: "Lesson 1: Possessive Structures", pageUrl: "../knowledge/grammar/level3/lesson-1.html" },
                    { title: "Lesson 2: Comparatives and Superlatives", pageUrl: "../knowledge/grammar/level3/lesson-2.html" },
                    { title: "Lesson 3: Imperatives and Commands", pageUrl: "../knowledge/grammar/level3/lesson-3.html" },
                    { title: "Lesson 4: Question Words", pageUrl: "../knowledge/grammar/level3/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Advanced Structures",
                subModuleId: "Grammar_4",
                lessons: [
                    { title: "Lesson 1: Conjunctions and Complex Sentences", pageUrl: "../knowledge/grammar/level4/lesson-1.html" },
                    { title: "Lesson 2: Conditional Sentences", pageUrl: "../knowledge/grammar/level4/lesson-2.html" },
                    { title: "Lesson 3: Expressing Opinions and Emotions", pageUrl: "../knowledge/grammar/level4/lesson-3.html" },
                    { title: "Lesson 4: Indirect Speech and Reported Questions", pageUrl: "../knowledge/grammar/level4/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Advanced Communication",
                subModuleId: "Grammar_5",
                lessons: [
                    { title: "Lesson 1: Nuances of Politeness", pageUrl: "../knowledge/grammar/level5/lesson-1.html" },
                    { title: "Lesson 2: Cultural Expressions and Idioms", pageUrl: "../knowledge/grammar/level5/lesson-2.html" },
                    { title: "Lesson 3: Error Correction and Clarification", pageUrl: "../knowledge/grammar/level5/lesson-3.html" },
                    { title: "Lesson 4: Style and Register", pageUrl: "../knowledge/grammar/level5/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Mastering Fluency",
                subModuleId: "Grammar_6",
                lessons: [
                    { title: "Lesson 1: Debating and Persuasion", pageUrl: "../knowledge/grammar/level6/lesson-1.html" },
                    { title: "Lesson 2: Storytelling and Narration", pageUrl: "../knowledge/grammar/level6/lesson-2.html" },
                    { title: "Lesson 3: Academic and Formal Writing", pageUrl: "../knowledge/grammar/level6/lesson-3.html" },
                    { title: "Lesson 4: Humor and Playfulness in Language", pageUrl: "../knowledge/grammar/level6/lesson-4.html" }
                    // Add more lessons
                ]
            }
        ]
    },
    {
        moduleName: "Comprehension",
        moduleId: "comprehensionModule",
        subModules: [
            {
                subModuleName: "Foundations of Comprehension",
                subModuleId: "Comprehension_1",
                lessons: [
                    { title: "Lesson 1: Understanding Basic Greetings and Introductions", pageUrl: "../knowledge/comprehension/level1/lesson-1.html" },
                    { title: "Lesson 2: Numbers and Time", pageUrl: "../knowledge/comprehension/level1/lesson-2.html" },
                    { title: "Lesson 3: Common Phrases and Responses", pageUrl: "../knowledge/comprehension/level1/lesson-3.html" },
                    { title: "Lesson 4: Simple Instructions and Commands", pageUrl: "../knowledge/comprehension/level1/lesson-4.html" }
                ]
            },
            {
                subModuleName: "Everyday Situations",
                subModuleId: "Comprehension_2",
                lessons: [
                    { title: "Lesson 1: Shopping Conversations", pageUrl: "../knowledge/comprehension/level2/lesson-1.html" },
                    { title: "Lesson 2: Restaurant and Food", pageUrl: "../knowledge/comprehension/level2/lesson-2.html" },
                    { title: "Lesson 3: Directions and Transportation", pageUrl: "../knowledge/comprehension/level2/lesson-3.html" },
                    { title: "Lesson 4: Weather and Seasons", pageUrl: "../knowledge/comprehension/level2/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Expanding Knowledge",
                subModuleId: "Comprehension_3",
                lessons: [
                    { title: "Lesson 1: Educational Content", pageUrl: "../knowledge/comprehension/level3/lesson-1.html" },
                    { title: "Lesson 2: Work and Occupation Dialogues", pageUrl: "../knowledge/comprehension/level3/lesson-2.html" },
                    { title: "Lesson 3: Health and Wellness", pageUrl: "../knowledge/comprehension/level3/lesson-3.html" },
                    { title: "Lesson 4: Entertainment and Media", pageUrl: "../knowledge/comprehension/level3/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Advanced Interpretation",
                subModuleId: "Comprehension_4",
                lessons: [
                    { title: "Lesson 1: Narratives and Storytelling", pageUrl: "../knowledge/comprehension/level4/lesson-1.html" },
                    { title: "Lesson 2: Opinions and Arguments", pageUrl: "../knowledge/comprehension/level4/lesson-2.html" },
                    { title: "Lesson 3: Cultural and Historical Texts", pageUrl: "../knowledge/comprehension/level4/lesson-3.html" },
                    { title: "Lesson 4: Technical and Scientific Articles", pageUrl: "../knowledge/comprehension/level4/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Mastery of Comprehension",
                subModuleId: "Comprehension_5",
                lessons: [
                    { title: "Lesson 1: Abstract and Philosophical Texts", pageUrl: "../knowledge/comprehension/level5/lesson-1.html" },
                    { title: "Lesson 2: Poetry and Literature", pageUrl: "../knowledge/comprehension/level5/lesson-2.html" },
                    { title: "Lesson 3: News and Current Events", pageUrl: "../knowledge/comprehension/level5/lesson-3.html" },
                    { title: "Lesson 4: Formal and Academic Papers", pageUrl: "../knowledge/comprehension/level5/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Applied Comprehension",
                subModuleId: "Comprehension_6",
                lessons: [
                    { title: "Lesson 1: Interactive Scenarios and Role Plays", pageUrl: "../knowledge/comprehension/level6/lesson-1.html" },
                    { title: "Lesson 2: Listening and Audio Comprehension", pageUrl: "../knowledge/comprehension/level6/lesson-2.html" },
                    { title: "Lesson 3: Visual Comprehension and Interpretation", pageUrl: "../knowledge/comprehension/level6/lesson-3.html" },
                    { title: "Lesson 4: Comprehension Through Creation", pageUrl: "../knowledge/comprehension/level6/lesson-4.html" }
                    // Add more lessons
                ]
            }
        ]
    },
    {
        moduleName: "Math",
        moduleId: "mathModule",
        subModules: [
            {
                subModuleName: "Understanding Base-12 Basics",
                subModuleId: "Math_1",
                lessons: [
                    { title: "Lesson 1: Introduction to Base-12 System", pageUrl: "../knowledge/math/level1/lesson-1.html" },
                    { title: "Lesson 2: Counting in Base-12", pageUrl: "../knowledge/math/level1/lesson-2.html" },
                    { title: "Lesson 3: Basic Operations in Base-12", pageUrl: "../knowledge/math/level1/lesson-3.html" },
                    { title: "Lesson 4: Multiplication and Division in Base-12", pageUrl: "../knowledge/math/level1/lesson-4.html" }
                ]
            },
            {
                subModuleName: "Advancing with Arithmetic",
                subModuleId: "Math_2",
                lessons: [
                    { title: "Lesson 1: Carrying and Borrowing in Base-12", pageUrl: "../knowledge/math/level2/lesson-1.html" },
                    { title: "Lesson 2: Advanced Multiplication and Division", pageUrl: "../knowledge/math/level2/lesson-2.html" },
                    { title: "Lesson 3: Fractions in Base-12", pageUrl: "../knowledge/math/level2/lesson-3.html" },
                    { title: "Lesson 4: Converting Between Base-10 and Base-12", pageUrl: "../knowledge/math/level2/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Exploring Further Concepts",
                subModuleId: "Math_3",
                lessons: [
                    { title: "Lesson 1: Base-12 Place Values", pageUrl: "../knowledge/math/level3/lesson-1.html" },
                    { title: "Lesson 2: Using Base-12 in Practical Situations", pageUrl: "../knowledge/math/level3/lesson-2.html" },
                    { title: "Lesson 3: Decimals in Base-12", pageUrl: "../knowledge/math/level3/lesson-3.html" },
                    { title: "Lesson 4: Ratios and Proportions in Base-12", pageUrl: "../knowledge/math/level3/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Dive into Geometry and Algebra",
                subModuleId: "Math_4",
                lessons: [
                    { title: "Lesson 1: Geometric Shapes and Measurements in Base-12", pageUrl: "../knowledge/math/level4/lesson-1.html" },
                    { title: "Lesson 2: Algebraic Expressions in Base-12", pageUrl: "../knowledge/math/level4/lesson-2.html" },
                    { title: "Lesson 3: Graphing in Base-12", pageUrl: "../knowledge/math/level4/lesson-3.html" },
                    { title: "Lesson 4: Statistics and Probability in Base-12", pageUrl: "../knowledge/math/level4/lesson-4.html" }
                    // Add more lessons
                ]
            },
            {
                subModuleName: "Complex Applications and Theoretical Concepts",
                subModuleId: "Math_5",
                lessons: [
                    { title: "Lesson 1: Mathematical Puzzles in Base-12", pageUrl: "../knowledge/math/level5/lesson-1.html" },
                    { title: "Lesson 2: Exploring Patterns and Sequences in Base-12", pageUrl: "../knowledge/math/level5/lesson-2.html" },
                    { title: "Lesson 3: Base-12 in Science and Technology", pageUrl: "../knowledge/math/level5/lesson-3.html" },
                    { title: "Lesson 4: Theoretical Math in Base-12", pageUrl: "../knowledge/math/level5/lesson-4.html" }
                    // Add more lessons
                ]
            }
        ]
    },

    // Add more modules
];

let userLearningMode = "Guided Learning"; // Or "Self-Directed Exploration"

// Placeholder for user's progress in each lesson
const userProgress = {
    vocabulary: {
        Vocabulary_1: {
            "Lesson 1: Common Phrases": true, // true indicates completion
            "Lesson 2: Numbers and Counting": true,
            "Lesson 3: Colors and Shapes": false,
            "Lesson 4: Time and Days": false,
        },
        Vocabulary_2: {
            "Lesson 1: Family and People": false,
            "Lesson 2: Food and Drink": false,
            "Lesson 3: Clothing and Body": false,
            "Lesson 4: Home and Daily Routines": false,
        },
        Vocabulary_3: {
            "Lesson 1: Nature and Weather": false,
            "Lesson 2: City and Transportation": false,
            "Lesson 3: Shopping and Money": false,
            "Lesson 4: Health and Emergency": false,
        },
        Vocabulary_4: {
            "Lesson 1: Emotions and Opinions": false,
            "Lesson 2: Hobbies and Leisure": false,
            "Lesson 3: Education and Work": false,
            "Lesson 4: Travel and Culture": false,
        },
        Vocabulary_5: {
            "Lesson 1: Complex Descriptions": false,
            "Lesson 2: Abstract Concepts": false,
            "Lesson 3: Formal and Informal Language": false,
            "Lesson 4: Compound Word Construction": false,
        },
        Vocabulary_6: {
            "Lesson 1: Science and Technology": false,
            "Lesson 2: Arts and Literature": false,
            "Lesson 3: Business and Economy": false,
            "Lesson 4: Politics and Society": false,
        }
    },
    grammar: {
        Grammar_1: {
            "Lesson 1: Sentence Structure": false,
            "Lesson 2: Pronouns and Simple Verbs": false,
            "Lesson 3: Present, Past, and Future Tenses": false,
            "Lesson 4: Yes/No Questions and Answers": false
        },
        Grammar_2: {
            "Lesson 1: Negation": false,
            "Lesson 2: Plurals and Quantity": false,
            "Lesson 3: Descriptive Language": false,
            "Lesson 4: Prepositions and Directions": false
        },
        Grammar_3: {
            "Lesson 1: Possessive Structures": false,
            "Lesson 2: Comparatives and Superlatives": false,
            "Lesson 3: Imperatives and Commands": false,
            "Lesson 4: Question Words": false
        },
        Grammar_4: {
            "Lesson 1: Conjunctions and Complex Sentences": false,
            "Lesson 2: Conditional Sentences": false,
            "Lesson 3: Expressing Opinions and Emotions": false,
            "Lesson 4: Indirect Speech and Reported Questions": false
        },
        Grammar_5: {
            "Lesson 1: Nuances of Politeness": false,
            "Lesson 2: Cultural Expressions and Idioms": false,
            "Lesson 3: Error Correction and Clarification": false,
            "Lesson 4: Style and Register": false
        },
        Grammar_6: {
            "Lesson 1: Debating and Persuasion": false,
            "Lesson 2: Storytelling and Narration": false,
            "Lesson 3: Academic and Formal Writing": false,
            "Lesson 4: Humor and Playfulness in Language": false
        }
    },
    comprehension: {
        Comprehension_1: {
            "Lesson 1: Understanding Basic Greetings and Introductions": false,
            "Lesson 2: Numbers and Time": false,
            "Lesson 3: Common Phrases and Responses": false,
            "Lesson 4: Simple Instructions and Commands": false
        },
        Comprehension_2: {
            "Lesson 1: Shopping Conversations": false,
            "Lesson 2: Restaurant and Food": false,
            "Lesson 3: Directions and Transportation": false,
            "Lesson 4: Weather and Seasons": false
        },
        Comprehension_3: {
            "Lesson 1: Educational Content": false,
            "Lesson 2: Work and Occupation Dialogues": false,
            "Lesson 3: Health and Wellness": false,
            "Lesson 4: Entertainment and Media": false
        },
        Comprehension_4: {
            "Lesson 1: Narratives and Storytelling": false,
            "Lesson 2: Opinions and Arguments": false,
            "Lesson 3: Cultural and Historical Texts": false,
            "Lesson 4: Technical and Scientific Articles": false
        },
        Comprehension_5: {
            "Lesson 1: Abstract and Philosophical Texts": false,
            "Lesson 2: Poetry and Literature": false,
            "Lesson 3: News and Current Events": false,
            "Lesson 4: Formal and Academic Papers": false
        },
        Comprehension_6: {
            "Lesson 1: Interactive Scenarios and Role Plays": false,
            "Lesson 2: Listening and Audio Comprehension": false,
            "Lesson 3: Visual Comprehension and Interpretation": false,
            "Lesson 4: Comprehension Through Creation": false
        }
    },
    math: {
        Math_1: {
            "Lesson 1: Introduction to Base-12 System": false,
            "Lesson 2: Counting in Base-12": false,
            "Lesson 3: Basic Operations in Base-12": false,
            "Lesson 4: Multiplication and Division in Base-12": false
        },
        Math_2: {
            "Lesson 1: Carrying and Borrowing in Base-12": false,
            "Lesson 2: Advanced Multiplication and Division": false,
            "Lesson 3: Fractions in Base-12": false,
            "Lesson 4: Converting Between Base-10 and Base-12": false
        },
        Math_3: {
            "Lesson 1: Base-12 Place Values": false,
            "Lesson 2: Using Base-12 in Practical Situations": false,
            "Lesson 3: Decimals in Base-12": false,
            "Lesson 4: Ratios and Proportions in Base-12": false
        },
        Math_4: {
            "Lesson 1: Geometric Shapes and Measurements in Base-12": false,
            "Lesson 2: Algebraic Expressions in Base-12": false,
            "Lesson 3: Graphing in Base-12": false,
            "Lesson 4: Statistics and Probability in Base-12": false
        },
        Math_5: {
            "Lesson 1: Mathematical Puzzles in Base-12": false,
            "Lesson 2: Exploring Patterns and Sequences in Base-12": false,
            "Lesson 3: Base-12 in Science and Technology": false,
            "Lesson 4: Theoretical Math in Base-12": false
        }
    },
    // Include other modules and submodules as necessary
};

// Placeholder for recommended module, submodule, and lessons
const recommendations = {
    module: "vocabulary",
    subModule: "Vocabulary_1",
    lessons: ["Lesson 1: Common Phrases"]
    // Assuming at least one lesson is recommended
};

document.addEventListener('DOMContentLoaded', function() {
    renderContent(); // Newly structured function to render content and apply initial settings
    expandModuleAndSubmodule();
});

function renderContent() {
    const knowledgeCenter = document.getElementById('knowledgeCenter');
    knowledgeCenter.innerHTML = '';
    courseContent.forEach(module => {
        const isRecommendedModule = module.moduleName === recommendations.module;
        let moduleHtml = `
            <div class="module ${isRecommendedModule ? 'recommended' : ''}" id="${module.moduleId}" data-module="${module.moduleName}">
                <h3>${module.moduleName}</h3>
                <div class="progressBar"><div class="progress"><span class="progress-text"></span></div></div>
                ${generateSubModulesHtml(module.subModules, isRecommendedModule)}
            </div>
        `;
        knowledgeCenter.insertAdjacentHTML('beforeend', moduleHtml);
    });

    // Apply learning mode restrictions and update module progress
    applyLearningMode();
    attachEventListeners(); // Attach event listeners after content is generated
    updateModuleProgress();
}

function expandModuleAndSubmodule() {
    const { module, submodule } = getQueryParams();

    if (module) {
        // Attempt to find the module element based on the 'data-module' attribute
        const moduleElement = document.querySelector(`.module[data-module="${module}"]`);

        if (moduleElement) {
            moduleElement.classList.add('expanded'); // Expand the module if found

            // Check if a submodule parameter exists and the module element was successfully found
            if (submodule && moduleElement) {
                // Use the found moduleElement as the context for finding the submodule
                const submoduleElement = moduleElement.querySelector(`.subModule[data-module="${submodule}"]`);

                if (submoduleElement) {
                    submoduleElement.classList.add('expanded'); // Expand the submodule if found
                    // Optionally scroll the submodule into view
                    submoduleElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    // Log or handle the case where the submodule wasn't found
                    console.error('Submodule element not found:', submodule);
                }
            }
        } else {
            // Log or handle the case where the module wasn't found
            console.error('Module element not found:', module);
        }
    }
}

function getQueryParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        module: params.get('module'),
        submodule: params.get('submodule')
    };
}

function updateModuleProgress() {
    document.querySelectorAll('.module').forEach(moduleElement => {
        if (!moduleElement.dataset.module) {
            console.error('Missing data-module attribute:', moduleElement);
            return;
        } 
        const moduleName = moduleElement.dataset.module.toLowerCase();
        let totalProgress = 0;
        let submoduleCount = 0;
        
        moduleElement.querySelectorAll('.subModule').forEach(subModuleElement => {
            const subModuleName = subModuleElement.dataset.subModule;
            const progressData = userProgress[moduleName] && userProgress[moduleName][subModuleName];
            if (progressData) {
                const lessonsCompleted = Object.values(progressData).filter(completed => completed).length;
                const totalLessons = Object.keys(progressData).length;
                const subModuleProgress = (lessonsCompleted / totalLessons) * 100;

                subModuleElement.querySelector('.progress').style.width = `${subModuleProgress}%`;

                totalProgress += subModuleProgress;
                submoduleCount++;
            }
        });

        if (submoduleCount > 0) {
            const moduleProgress = totalProgress / submoduleCount;
            moduleElement.querySelector('.progress').style.width = `${moduleProgress}%`;
            moduleElement.querySelector('.progress-text').textContent = `${moduleProgress.toFixed(0)}%`;
        }
    });
}

function toggleModule(module) {
    const isExpanded = module.classList.toggle('expanded');
    const subModules = module.querySelectorAll('.subModule');
    subModules.forEach(subModule => {
        subModule.style.display = isExpanded ? 'block' : 'none';
    });
}

function toggleLessonsVisibility(subModule) {
    const isExpanded = subModule.classList.toggle('expanded');
    const lessonsList = subModule.querySelector('.lessonsList');
    lessonsList.style.display = isExpanded ? 'block' : 'none';
}

function attachEventListeners() {
    // Module and submodule toggle functionality
    document.querySelectorAll('.module').forEach(module => {
        module.addEventListener('click', function(event) {
            if (!event.target.closest('.subModule, a')) {
                toggleModule(event.currentTarget);
            }
        });
    });

    document.querySelectorAll('.subModule').forEach(subModule => {
        subModule.addEventListener('click', function(event) {
            // Prevents submodule toggle when clicking on links or any interactive element within it
            if (!event.target.closest('a, button, input, [onclick]')) {
                toggleLessonsVisibility(this);
            }
            event.stopPropagation(); // Prevent triggering module toggle
        });
    });

    // Apply click event listener to lesson links
    document.querySelectorAll('.lessonsList a').forEach(link => {
        link.addEventListener('click', (event) => {
            if (link.classList.contains('locked')) {
                event.preventDefault(); // Prevent navigation for locked lessons
                alert("This lesson is currently locked.");
            }
            event.stopPropagation(); // Ensure this doesn't trigger module/submodule toggling
        });
    });
}

function generateSubModulesHtml(subModules, isParentModuleRecommended) {
    return subModules.map(subModule => {
        const isRecommendedSubModule = isParentModuleRecommended && subModule.subModuleId === recommendations.subModule;
        return `
            <div class="subModule ${isRecommendedSubModule ? 'recommended' : ''}" data-sub-module="${subModule.subModuleId}">
                <div class="subModuleHeader"><h4>${subModule.subModuleName}</h4></div>
                <div class="progressBar"><div class="progress"></div></div>
                <ul class="lessonsList">
                    ${subModule.lessons.map(lesson => {
                        const isAccessible = isLessonRecommendedOrCompleted(lesson.title, subModule.subModuleId);

                        return `<li>
                            <a href="${lesson.pageUrl}" class="lessonLink ${isAccessible ? '' : 'locked'}" data-lesson="${lesson.title}">
                                ${lesson.title}
                            </a>
                        </li>`;
                    }).join('')}
                </ul>
            </div>
        `;
    }).join('');
}

function isLessonRecommendedOrCompleted(lessonTitle, subModuleId) {
    // In Guided Learning mode, a lesson is accessible if it's recommended or already completed
    if (userLearningMode === "Guided Learning") {
        const isCompleted = userProgress[subModuleId] && userProgress[subModuleId][lessonTitle];
        const isRecommended = recommendations.subModule === subModuleId && recommendations.lessons.includes(lessonTitle);
        
        return isRecommended || isCompleted;
    }
    // In Self-Directed Exploration, all lessons are accessible
    return true;
}

function applyLearningMode() {
    // For "Self-Directed Exploration", no need to lock lessons, so no action is required
    document.querySelectorAll('.lessonsList a').forEach(link => {
        // Adjust based on userLearningMode
        if (userLearningMode === "Guided Learning") {
            lockOrUnlockLessons();
        }
        // The locking logic is integrated within the generation of the lesson links
        // This function could be extended for additional logic specific to learning modes
    });
}

function lockOrUnlockLessons() {
    document.querySelectorAll('.lessonsList a').forEach(link => {
        const lessonName = link.getAttribute('data-lesson');
        const moduleName = link.closest('.module').getAttribute('data-module').toLowerCase().trim();
        const subModuleName = link.closest('.subModule').getAttribute('data-sub-module').trim();

        // Determine if the lesson should be accessible
        const isRecommended = recommendations.module.toLowerCase() === moduleName &&
                              recommendations.subModule === subModuleName &&
                              recommendations.lessons.includes(lessonName);
        
        const isCompleted = userProgress[moduleName] && 
                            userProgress[moduleName][subModuleName] && 
                            userProgress[moduleName][subModuleName][lessonName];
                            
        if (!isRecommended && !isCompleted) {
            // Mark as locked if not recommended or completed
            link.classList.add('locked');
        } else {
            link.classList.remove('locked');
        }
    });
}